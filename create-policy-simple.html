<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Policy - Vehicle Insurance Platform</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" onclick="toggleMobileMenu()"></div>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>Insurance Portal</h1>
      </div>

      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item">Dashboard</a>
        <a href="create-policy-simple.html" class="nav-item active">Create Policy</a>
        <a href="view-policies.html" class="nav-item">View Policies</a>
        <a href="data.html" class="nav-item">Test Data</a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="user-details">
            <h4 id="userName"></h4>
            <p id="userBranch"></p>
          </div>
        </div>
        <button onclick="handleLogout()" class="btn btn-secondary btn-block">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h2>Create New Policy (Simplified)</h2>
        <p>Quick policy creation with essential fields only</p>
      </div>

      <div class="card">
        <form id="policyForm">
          <!-- Policy Number -->
          <div class="form-group">
            <label class="form-label">Policy Number</label>
            <input type="text" id="policyNumber" class="form-input" readonly>
          </div>

          <!-- Policyholder Name -->
          <div class="form-group">
            <label class="form-label required" for="policyholderName">Full Name</label>
            <input type="text" id="policyholderName" class="form-input" placeholder="Enter full name" required>
            <div class="field-error"></div>
          </div>

          <!-- Email -->
          <div class="form-group">
            <label class="form-label required" for="email">Email Address</label>
            <input type="email" id="email" class="form-input" placeholder="example@email.com" required>
            <div class="field-error"></div>
          </div>

          <!-- Phone -->
          <div class="form-group">
            <label class="form-label required" for="phone">Phone Number</label>
            <input type="tel" id="phone" class="form-input" placeholder="10-digit phone number" required>
            <div class="field-error"></div>
          </div>

          <!-- Vehicle Type -->
          <div class="form-group">
            <label class="form-label required" for="vehicleType">Vehicle Type</label>
            <select id="vehicleType" class="form-select" required>
              <option value="">Select Type</option>
              <option value="car">Car</option>
              <option value="bike">Bike/Two Wheeler</option>
              <option value="commercial">Commercial Vehicle</option>
            </select>
            <div class="field-error"></div>
          </div>

          <!-- Vehicle Number -->
          <div class="form-group">
            <label class="form-label required" for="vehicleNumber">Vehicle Registration Number</label>
            <input type="text" id="vehicleNumber" class="form-input" placeholder="e.g., MH01AB1234" required style="text-transform: uppercase;">
            <div class="field-error"></div>
          </div>

          <!-- Coverage Type -->
          <div class="form-group">
            <label class="form-label required">Coverage Type</label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="thirdParty" name="coverageType" value="third-party" required>
                <label for="thirdParty">Third Party</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="comprehensive" name="coverageType" value="comprehensive" required>
                <label for="comprehensive">Comprehensive</label>
              </div>
            </div>
            <div class="field-error"></div>
          </div>

          <!-- Premium Amount -->
          <div class="form-group">
            <label class="form-label required" for="premium">Premium Amount (₹)</label>
            <input type="number" id="premium" class="form-input" placeholder="e.g., 15000" min="1000" required>
            <div class="field-error"></div>
          </div>

          <!-- Action Buttons -->
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">Create Policy</button>
            <button type="reset" class="btn btn-secondary">Reset Form</button>
            <a href="dashboard.html" class="btn btn-outline">Cancel</a>
          </div>
        </form>
      </div>
    </main>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
  </div>

  <script src="js/data.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>
  <script>
    // Mobile menu toggle
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.mobile-overlay');
      sidebar.classList.toggle('mobile-open');
      overlay.classList.toggle('show');
    }

    // Load user info
    function loadUserInfo() {
      const user = auth.getCurrentUser();
      if (!user) return;

      document.getElementById('userName').textContent = user.name;
      document.getElementById('userBranch').textContent = user.branch;

      const initial = user.name.charAt(0).toUpperCase();
      document.getElementById('userAvatar').textContent = initial;
    }

    // Logout handler
    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        auth.logout();
        showToast('Logged out successfully', 'success');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 500);
      }
    }

    // Generate and set policy number
    function setPolicyNumber() {
      document.getElementById('policyNumber').value = generatePolicyNumber();
    }

    // Form submission
    document.getElementById('policyForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate all fields
      let isValid = true;

      // Clear all previous errors
      document.querySelectorAll('.form-input, .form-select').forEach(field => {
        clearFieldError(field);
      });

      // Validate name
      const name = document.getElementById('policyholderName');
      const nameErrors = validateField(name, [{ type: 'required' }]);
      if (nameErrors.length > 0) {
        showFieldError(name, nameErrors);
        isValid = false;
      }

      // Validate email
      const email = document.getElementById('email');
      const emailErrors = validateField(email, [
        { type: 'required' },
        { type: 'email' }
      ]);
      if (emailErrors.length > 0) {
        showFieldError(email, emailErrors);
        isValid = false;
      }

      // Validate phone
      const phone = document.getElementById('phone');
      const phoneErrors = validateField(phone, [
        { type: 'required' },
        { type: 'phone' }
      ]);
      if (phoneErrors.length > 0) {
        showFieldError(phone, phoneErrors);
        isValid = false;
      }

      // Validate vehicle type
      const vehicleType = document.getElementById('vehicleType');
      const vehicleTypeErrors = validateField(vehicleType, [{ type: 'required' }]);
      if (vehicleTypeErrors.length > 0) {
        showFieldError(vehicleType, vehicleTypeErrors);
        isValid = false;
      }

      // Validate vehicle number
      const vehicleNumber = document.getElementById('vehicleNumber');
      const vehicleNumberErrors = validateField(vehicleNumber, [
        { type: 'required' },
        { type: 'vehicleNumber' }
      ]);
      if (vehicleNumberErrors.length > 0) {
        showFieldError(vehicleNumber, vehicleNumberErrors);
        isValid = false;
      }

      // Validate coverage type
      const coverageType = document.querySelector('input[name="coverageType"]:checked');
      if (!coverageType) {
        showToast('Please select a coverage type', 'error');
        isValid = false;
      }

      // Validate premium
      const premium = document.getElementById('premium');
      const premiumErrors = validateField(premium, [
        { type: 'required' },
        { type: 'minValue', min: 1000, message: 'Minimum premium is ₹1,000' }
      ]);
      if (premiumErrors.length > 0) {
        showFieldError(premium, premiumErrors);
        isValid = false;
      }

      if (!isValid) {
        showToast('Please fix all errors before submitting', 'error');
        return;
      }

      // Create simplified policy object
      const user = auth.getCurrentUser();
      const policyData = {
        policyNumber: document.getElementById('policyNumber').value,
        dealerId: user.id,
        policyholderName: name.value,
        email: email.value,
        phone: phone.value,
        dob: '1990-01-01', // Default
        address: 'Not specified', // Default
        state: 'Not specified', // Default
        vehicleType: vehicleType.value,
        vehicleMake: 'Generic', // Default
        vehicleModel: 'Not specified', // Default
        vehicleNumber: vehicleNumber.value.toUpperCase(),
        manufactureYear: '2020', // Default
        coverageType: coverageType.value,
        addOns: [],
        sumAssured: parseInt(premium.value) * 10, // Auto-calculate
        premium: parseInt(premium.value),
        paymentFrequency: 'yearly', // Default
        policyStartDate: new Date().toISOString().split('T')[0],
        status: 'Active',
        createdAt: new Date().toISOString()
      };

      // Save policy
      try {
        showLoading();
        const result = await savePolicy(policyData);
        hideLoading();

        if (result.success) {
          showToast(`Policy ${result.policyNumber} created successfully!`, 'success');
          setTimeout(() => {
            window.location.href = 'view-policies.html';
          }, 1500);
        }
      } catch (error) {
        hideLoading();
        showToast(error.message || 'Failed to create policy. Please try again.', 'error');
      }
    });

    // Reset form handler
    document.getElementById('policyForm').addEventListener('reset', () => {
      setPolicyNumber();
      document.querySelectorAll('.form-input, .form-select').forEach(field => {
        clearFieldError(field);
      });
    });

    // Initialize
    loadUserInfo();
    setPolicyNumber();
  </script>
</body>
</html>
